apiVersion: apps/v1
kind: DaemonSet
metadata:
    name: spire-agent
    namespace: spire-agent
    labels:
        app: spire-agent
spec:
    selector:
        matchLabels:
            app: spire-agent
    template:
        metadata:
            labels:
                app: spire-agent
        spec:
            serviceAccountName: spire-agent
            hostPID: true
            hostNetwork: true
            dnsPolicy: ClusterFirstWithHostNet
            containers:
                - name: spire-agent
                  image: ghcr.io/spiffe/spire-agent:1.13.0
                  imagePullPolicy: IfNotPresent
                  args:
                      - -config
                      - /run/spire/config/agent.conf
                  volumeMounts:
                      # Agent configuration
                      - name: spire-agent-config
                        mountPath: /run/spire/config
                        readOnly: true
                      # Bootstrap bundle (trust bundle)
                      - name: spire-bundle
                        mountPath: /run/spire/bundle
                        readOnly: true
                      # Agent socket directory (shared with host for workload API)
                      - name: spire-agent-socket
                        mountPath: /run/spire/sockets
                      # Agent data directory
                      - name: spire-agent-data
                        mountPath: /run/spire/data
                      # Service account token for k8s_psat node attestation
                      - name: spire-agent-token
                        mountPath: /var/run/secrets/tokens
                        readOnly: true
                  env:
                      - name: POD_NAMESPACE
                        valueFrom:
                            fieldRef:
                                fieldPath: metadata.namespace
                      - name: POD_NAME
                        valueFrom:
                            fieldRef:
                                fieldPath: metadata.name
                      - name: POD_UID
                        valueFrom:
                            fieldRef:
                                fieldPath: metadata.uid
                  resources:
                      requests:
                          cpu: 100m
                          memory: 128Mi
                      limits:
                          cpu: 500m
                          memory: 512Mi
                  livenessProbe:
                      exec:
                          command:
                              - /opt/spire/bin/spire-agent
                              - healthcheck
                              - -socketPath
                              - /run/spire/sockets/agent.sock
                      initialDelaySeconds: 60
                      periodSeconds: 30
                      timeoutSeconds: 5
                      failureThreshold: 5
                  readinessProbe:
                      exec:
                          command:
                              - /opt/spire/bin/spire-agent
                              - healthcheck
                              - -socketPath
                              - /run/spire/sockets/agent.sock
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 6
            volumes:
                - name: spire-agent-config
                  configMap:
                      name: spire-agent-config
                - name: spire-bundle
                  secret:
                      secretName: spire-bundle
                - name: spire-agent-socket
                  hostPath:
                      path: /run/spire/sockets
                      type: DirectoryOrCreate
                - name: spire-agent-data
                  hostPath:
                      path: /var/lib/spire-agent
                      type: DirectoryOrCreate
                - name: spire-agent-token
                  projected:
                      sources:
                          - serviceAccountToken:
                                path: spire-agent
                                expirationSeconds: 3600
                                audience: spire-server
            tolerations:
                # Allow running on control-plane nodes
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
                  effect: NoSchedule
                - key: node-role.kubernetes.io/master
                  operator: Exists
                  effect: NoSchedule
