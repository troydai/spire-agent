apiVersion: apps/v1
kind: Deployment
metadata:
    name: spire-server
    namespace: spire-server
    labels:
        app: spire-server
        component: server
spec:
    replicas: 1
    selector:
        matchLabels:
            app: spire-server
            component: server
    template:
        metadata:
            labels:
                app: spire-server
                component: server
        spec:
            serviceAccountName: spire-server
            containers:
                - name: spire-server
                  image: ghcr.io/spiffe/spire-server:1.13.0
                  imagePullPolicy: IfNotPresent
                  args:
                      - -config
                      - /run/spire/config/server.conf
                  ports:
                      - name: api
                        containerPort: 8081
                        protocol: TCP
                  volumeMounts:
                      - name: config
                        mountPath: /run/spire/config
                        readOnly: true
                      - name: server-tls
                        mountPath: /run/spire/secrets/server
                        readOnly: true
                      - name: ca-cert
                        mountPath: /run/spire/secrets/ca
                        readOnly: true
                      - name: bootstrap-bundle
                        mountPath: /run/spire/secrets/bootstrap
                        readOnly: true
                      - name: data
                        mountPath: /run/spire/data
                  livenessProbe:
                      tcpSocket:
                          port: 8081
                      initialDelaySeconds: 15
                      periodSeconds: 30
                      timeoutSeconds: 5
                      failureThreshold: 3
                  readinessProbe:
                      tcpSocket:
                          port: 8081
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "100m"
                      limits:
                          memory: "512Mi"
                          cpu: "500m"
            volumes:
                - name: config
                  configMap:
                      name: spire-server-config
                - name: server-tls
                  secret:
                      secretName: spire-server-tls
                - name: ca-cert
                  secret:
                      secretName: spire-server-ca
                - name: bootstrap-bundle
                  secret:
                      secretName: spire-server-bootstrap
                - name: data
                  emptyDir: {}
