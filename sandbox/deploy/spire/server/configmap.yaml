apiVersion: v1
kind: ConfigMap
metadata:
    name: spire-server-config
    namespace: spire-server
    labels:
        app: spire-server
        component: server
data:
    server.conf: |
        server {
            bind_address = "0.0.0.0"
            bind_port = "8081"
            trust_domain = "spiffe-helper.local"
            data_dir = "/run/spire/data"
            log_level = "DEBUG"
            log_format = "text"

            # Short TTL for integration testing - certificates rotate at ~half TTL
            # 2 minute TTL means rotation happens around 1 minute
            default_x509_svid_ttl = "120s"
        }

        plugins {
            DataStore "sql" {
                plugin_data {
                    database_type = "sqlite3"
                    connection_string = "/run/spire/data/datastore.sqlite3"
                }
            }

            NodeAttestor "k8s_psat" {
                plugin_data {
                    clusters = {
                        "spiffe-helper" = {
                            service_account_allow_list = ["spire-server:spire-server", "spire-agent:spire-agent"]
                        }
                    }
                }
            }

            KeyManager "disk" {
                plugin_data {
                    keys_path = "/run/spire/data/keys.json"
                }
            }

            UpstreamAuthority "disk" {
                plugin_data {
                    key_file_path = "/run/spire/secrets/ca/ca.key"
                    cert_file_path = "/run/spire/secrets/ca/ca.crt"
                }
            }
        }
